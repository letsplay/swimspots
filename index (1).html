<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SwimSpot ‚Äî Wireframe V5.0</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --favorable: #16a34a;
      --favorable-bg: rgba(22, 163, 74, 0.1);
      --technique: #f59e0b;
      --technique-bg: rgba(245, 158, 11, 0.1);
      --exigeant: #ef4444;
      --exigeant-bg: rgba(239, 68, 68, 0.1);
      --primary: #0369a1;
      --primary-light: #0ea5e9;
      --text: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --bg: #f8fafc;
      --white: #ffffff;
    }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(135deg, #0c1821 0%, #1a3a4a 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }
    
    .phone-frame {
      width: 100%;
      max-width: 390px;
      height: 844px;
      background: var(--white);
      border-radius: 44px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 0 0 3px #2a2a2a, 0 0 0 6px #1a1a1a, 0 25px 80px rgba(0,0,0,0.6);
    }
    
    .dynamic-island {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 125px;
      height: 36px;
      background: #000;
      border-radius: 20px;
      z-index: 1000;
    }
    
    .screen { display: none; height: 100%; flex-direction: column; position: relative; background: var(--bg); }
    .screen.active { display: flex; }
    
    .header {
      background: var(--white);
      padding: 54px 16px 12px;
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 100;
    }
    
    .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .logo-text { font-weight: 800; font-size: 18px; color: var(--text); }
    
    .search-bar {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .search-bar input {
      flex: 1; border: none; background: transparent;
      font-size: 14px; color: var(--text); outline: none; font-family: inherit;
      min-width: 0;
    }
    .search-bar input::placeholder { color: var(--text-muted); }
    
    .location-buttons {
      display: flex; gap: 4px;
      flex-shrink: 0;
    }
    .location-btn {
      display: flex; align-items: center; gap: 2px;
      padding: 5px 8px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 10px; font-weight: 600; color: var(--text);
      cursor: pointer;
      white-space: nowrap;
      font-family: inherit;
    }
    .location-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .map-container {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .leaflet-container {
      font-family: 'Inter', sans-serif;
    }
    
    /* Custom markers */
    .custom-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer !important;
    }
    
    .marker-temp {
      background: rgba(17, 24, 39, 0.9);
      color: white;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 800;
      margin-bottom: 3px;
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
    }
    
    .marker-pin {
      width: 28px;
      height: 28px;
      border-radius: 50% 50% 50% 0;
      transform: rotate(-45deg);
      border: 2.5px solid white;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    
    .marker-pin.favorable { background: #16a34a; }
    .marker-pin.technique { background: #f59e0b; }
    .marker-pin.exigeant { background: #ef4444; }
    
    .marker-pin::after {
      content: '';
      width: 10px;
      height: 10px;
      background: rgba(255,255,255,0.9);
      border-radius: 50%;
      transform: rotate(45deg);
    }
    
    .marker-name {
      background: white;
      color: #111827;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 9px;
      font-weight: 700;
      margin-top: 4px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      white-space: nowrap;
      font-family: 'Inter', sans-serif;
    }
    
    .custom-marker:hover .marker-pin {
      transform: rotate(-45deg) scale(1.15);
    }
    
    .map-legend {
      position: absolute;
      top: 12px; right: 12px;
      background: var(--white);
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      z-index: 1000;
      font-size: 11px;
    }
    .legend-title { font-weight: 800; color: var(--text); margin-bottom: 10px; font-size: 12px; }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .legend-item:last-child { margin-bottom: 0; }
    .legend-dot {
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .legend-dot.favorable { background: var(--favorable); }
    .legend-dot.technique { background: var(--technique); }
    .legend-dot.exigeant { background: var(--exigeant); }
    .legend-label { font-weight: 600; color: var(--text); }
    
    .previsions-panel {
      background: var(--white);
      border-top: 1px solid var(--border);
      padding: 14px 16px;
      z-index: 10;
    }
    .previsions-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .previsions-title { font-weight: 800; font-size: 14px; color: var(--text); }
    .previsions-time {
      padding: 6px 12px;
      background: var(--primary);
      border-radius: 8px;
      font-size: 12px; font-weight: 700; color: white;
      min-width: 130px; text-align: center;
      white-space: nowrap;
    }
    .previsions-slider {
      width: 100%; height: 8px; border-radius: 4px;
      background: var(--border);
      appearance: none; cursor: pointer; outline: none;
    }
    .previsions-slider::-webkit-slider-thumb {
      appearance: none;
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--primary);
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      cursor: pointer;
    }
    .slider-labels { display: flex; justify-content: space-between; margin-top: 8px; }
    .slider-label { font-size: 9px; color: var(--text-muted); font-weight: 600; }
    .slider-label.active { color: var(--primary); font-weight: 700; }
    .previsions-hint {
      margin-top: 10px; padding: 10px 12px;
      background: rgba(3, 105, 161, 0.08);
      border-radius: 10px;
      font-size: 11px; color: var(--text-muted);
      display: flex; align-items: center; gap: 8px;
    }
    .previsions-hint strong { color: var(--text); }
    
    .nav-bar {
      display: flex; justify-content: space-around;
      padding: 10px 20px 20px;
      background: var(--white);
      border-top: 1px solid var(--border);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      padding: 8px 24px; border-radius: 12px;
      background: transparent; border: none;
      color: var(--text-muted); cursor: pointer; font-family: inherit;
    }
    .nav-item.active { color: var(--primary); background: rgba(3, 105, 161, 0.1); }
    .nav-icon { font-size: 22px; }
    .nav-label { font-size: 10px; font-weight: 600; }
    
    .spot-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      padding: 54px 16px 16px;
      color: white;
    }
    .spot-header-top { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .spot-back {
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.2);
      border-radius: 12px; border: none;
      color: white; font-size: 18px; cursor: pointer;
    }
    .spot-title { flex: 1; }
    .spot-name { font-size: 20px; font-weight: 800; }
    .spot-location { font-size: 12px; opacity: 0.8; margin-top: 2px; }
    .spot-status-bar { display: flex; gap: 10px; }
    .spot-status-badge {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.2);
      border-radius: 20px;
      font-size: 13px; font-weight: 700;
    }
    .spot-content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 90px; }
    
    .status-hero { padding: 12px 16px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
    .status-hero.favorable { background: var(--favorable-bg); border: 1px solid rgba(22,163,74,0.2); }
    .status-hero.technique { background: var(--technique-bg); border: 1px solid rgba(245,158,11,0.2); }
    .status-hero.exigeant { background: var(--exigeant-bg); border: 1px solid rgba(239,68,68,0.2); }
    .status-hero-icon { font-size: 24px; }
    .status-hero-content { flex: 1; }
    .status-hero-title { font-size: 15px; font-weight: 800; }
    .status-hero.favorable .status-hero-title { color: var(--favorable); }
    .status-hero.technique .status-hero-title { color: var(--technique); }
    .status-hero.exigeant .status-hero-title { color: var(--exigeant); }
    .status-hero-subtitle { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
    
    .disclaimer {
      padding: 8px 12px; background: var(--bg);
      border-radius: 8px;
      margin-bottom: 12px; font-size: 11px; color: var(--text-muted);
      text-align: center;
    }
    
    .conditions-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 14px; }
    .condition-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .condition-card.danger { background: var(--exigeant-bg); border-color: rgba(239,68,68,0.3); }
    .condition-card.danger .condition-value { color: var(--exigeant); }
    .condition-card.warning { background: var(--technique-bg); border-color: rgba(245,158,11,0.3); }
    .condition-card.warning .condition-value { color: var(--technique); }
    .condition-label { font-size: 10px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; }
    .condition-value { font-size: 18px; font-weight: 800; color: var(--text); }
    .condition-desc { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    
    .section { margin-bottom: 14px; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .section-title { font-size: 13px; font-weight: 800; color: var(--text); display: flex; align-items: center; gap: 6px; }
    .section-badge { padding: 3px 6px; background: var(--primary); border-radius: 4px; font-size: 9px; font-weight: 700; color: white; }
    .section-action { padding: 5px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 600; color: var(--primary); cursor: pointer; }
    
    .karma-explainer {
      display: none;
      background: linear-gradient(135deg, rgba(3,105,161,0.1) 0%, rgba(14,165,233,0.1) 100%);
      border: 1px solid rgba(3,105,161,0.2);
      border-radius: 12px; padding: 12px; margin-bottom: 12px;
    }
    .karma-explainer.show { display: block; }
    .karma-explainer-title { font-size: 12px; font-weight: 800; color: var(--primary); margin-bottom: 6px; }
    .karma-explainer-text { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
    .karma-rules { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
    .karma-rule { display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--text); }
    .karma-rule-points { padding: 2px 6px; background: var(--white); border-radius: 4px; font-weight: 700; color: var(--favorable); font-size: 10px; }
    
    .karma-badge {
      padding: 2px 6px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border-radius: 6px;
      font-size: 9px;
      font-weight: 700;
      color: white;
      cursor: pointer;
      margin-left: 4px;
    }
    .karma-badge:hover { opacity: 0.8; }
    
    .local-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 8px; }
    .local-card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .local-card-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .local-card-icon.tip { background: var(--favorable-bg); }
    .local-card-icon.warning { background: var(--technique-bg); }
    .local-card-title { flex: 1; font-size: 12px; font-weight: 700; color: var(--text); }
    .local-card-badge { padding: 2px 6px; background: var(--bg); border-radius: 4px; font-size: 9px; font-weight: 600; color: var(--text-muted); }
    .local-card-desc { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
    .local-card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
    .local-card-karma { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; }
    .local-card-karma strong { color: var(--text); }
    .verify-btn { padding: 5px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; font-weight: 600; color: var(--text); cursor: pointer; font-family: inherit; }
    .verify-btn.verified { background: var(--favorable-bg); border-color: var(--favorable); color: var(--favorable); }
    
    .route-card { background: var(--white); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 8px; cursor: pointer; }
    .route-card-header { display: flex; align-items: center; gap: 10px; }
    .route-distance { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
    .route-distance-value { font-size: 14px; font-weight: 800; }
    .route-distance-unit { font-size: 8px; font-weight: 600; opacity: 0.8; }
    .route-info { flex: 1; }
    .route-name { font-size: 12px; font-weight: 700; color: var(--text); }
    .route-meta { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
    .route-arrow { color: var(--text-muted); font-size: 16px; }
    
    .sources-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .source-card { background: var(--white); border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
    .source-name { font-size: 11px; font-weight: 700; color: var(--text); }
    .source-desc { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
    
    .toast {
      position: absolute; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 12px 20px; background: var(--text); color: white;
      border-radius: 12px; font-size: 13px; font-weight: 600;
      opacity: 0; transition: all 0.3s; z-index: 4000;
      white-space: nowrap;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    
    /* Quick Add Modal - inside phone frame */
    .modal-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none; align-items: flex-end; justify-content: center;
      z-index: 3000;
      border-radius: 44px;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: white;
      border-radius: 20px 20px 0 0;
      width: 100%;
      padding: 16px;
      animation: slideUp 0.3s ease;
      max-height: 70%;
      overflow-y: auto;
    }
    .modal-content.modal-fullscreen {
      max-height: 85%;
      padding: 12px;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title { font-size: 15px; font-weight: 800; color: var(--text); }
    .modal-close {
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--bg); border: none;
      font-size: 16px; cursor: pointer; color: var(--text-muted);
    }
    .modal-form { display: flex; flex-direction: column; gap: 10px; }
    .modal-form.compact { gap: 8px; }
    .form-group label {
      display: block; font-size: 10px; font-weight: 600;
      color: var(--text-muted); margin-bottom: 3px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 8px 10px;
      border: 1px solid var(--border); border-radius: 8px;
      font-size: 13px; font-family: inherit;
      outline: none;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: var(--primary);
    }
    .form-group textarea { resize: none; height: 60px; }
    .form-row { display: flex; gap: 8px; }
    .form-row .form-group { flex: 1; }
    .modal-submit {
      width: 100%; padding: 12px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none; border-radius: 10px;
      color: white; font-size: 13px; font-weight: 700;
      cursor: pointer; font-family: inherit;
    }
    .modal-submit:active { opacity: 0.9; }
    .type-selector { display: flex; gap: 6px; margin-bottom: 10px; }
    .type-btn {
      flex: 1; padding: 8px 6px;
      background: var(--bg); border: 2px solid var(--border);
      border-radius: 8px; cursor: pointer;
      text-align: center; font-family: inherit;
    }
    .type-btn.active { border-color: var(--primary); background: rgba(3,105,161,0.1); }
    .type-btn-icon { font-size: 18px; margin-bottom: 2px; }
    .type-btn-label { font-size: 9px; font-weight: 600; color: var(--text); }
    
    /* Route Map Drawing */
    .route-map-container {
      position: relative;
      height: 220px;
      background: #e8f4f8;
      border-radius: 12px;
      margin-bottom: 10px;
      overflow: hidden;
    }
    #routeMapDraw {
      width: 100%;
      height: 100%;
    }
    .route-map-hint {
      position: absolute;
      top: 8px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .route-map-toolbar {
      position: absolute;
      bottom: 8px; left: 8px;
      display: flex; gap: 4px;
      z-index: 1000;
    }
    .toolbar-btn {
      padding: 6px 8px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .toolbar-btn:active { background: var(--bg); }
    .toolbar-btn.primary {
      background: var(--favorable);
      color: white;
      border-color: var(--favorable);
    }
    .route-distance-display {
      position: absolute;
      bottom: 8px; right: 8px;
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      z-index: 1000;
    }
    .route-points-count {
      position: absolute;
      top: 8px; right: 8px;
      background: white;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    
    /* Point label on map */
    .point-label {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      font-size: 9px !important;
      font-weight: 800 !important;
      color: white !important;
    }
    
    /* CREATE SCREEN - Map-centric */
    .create-map-container {
      position: relative;
      flex: 1;
      min-height: 0;
    }
    #createMap {
      width: 100%;
      height: 100%;
    }
    .create-map-header {
      position: absolute;
      top: 50px; left: 12px; right: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 1000;
    }
    .create-back-btn {
      width: 36px; height: 36px;
      background: white;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    .create-title {
      background: white;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .create-search {
      flex: 1;
    }
    .create-search input {
      width: 100%;
      padding: 8px 12px;
      border: none;
      border-radius: 20px;
      font-size: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      outline: none;
    }
    .create-hint {
      position: absolute;
      bottom: 200px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      z-index: 1000;
      white-space: nowrap;
    }
    .create-coords {
      position: absolute;
      bottom: 200px; left: 50%;
      transform: translateX(-50%);
      background: var(--primary);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .coords-clear {
      background: rgba(255,255,255,0.3);
      border: none;
      width: 18px; height: 18px;
      border-radius: 50%;
      color: white;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .create-actions {
      background: white;
      padding: 12px 16px 16px;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    }
    .create-actions-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 10px;
      text-align: center;
    }
    .create-actions-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .create-action-btn {
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 10px 4px;
      text-align: center;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .create-action-btn:active {
      transform: scale(0.95);
    }
    .create-action-btn.disabled {
      opacity: 0.4;
    }
    .create-action-btn.active {
      border-color: var(--primary);
      background: rgba(3,105,161,0.1);
    }
    .create-action-icon {
      font-size: 22px;
      margin-bottom: 4px;
    }
    .create-action-label {
      font-size: 9px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }
    .create-action-karma {
      font-size: 8px;
      color: var(--favorable);
      margin-top: 2px;
    }
    
    /* Create Form Panels */
    .create-form-panel {
      position: absolute;
      bottom: 70px; left: 0; right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      z-index: 2000;
      animation: slideUp 0.3s ease;
      max-height: calc(100% - 180px);
      overflow-y: auto;
    }
    .create-form-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .create-form-back {
      width: 32px; height: 32px;
      background: var(--bg);
      border: none;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
    }
    .create-form-title {
      font-size: 15px;
      font-weight: 800;
      color: var(--text);
    }
    .create-form-content {
      padding: 12px 16px 20px;
      max-height: 350px;
      overflow-y: auto;
    }
    
    .route-draw-hint {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg);
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 11px;
    }
    .route-draw-distance {
      font-weight: 800;
      color: var(--primary);
    }
    .route-draw-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .route-info-box {
      background: rgba(3,105,161,0.1);
      border: 1px solid rgba(3,105,161,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 10px;
      color: var(--primary);
      margin-bottom: 8px;
      text-align: center;
    }
    
    /* Disabled state message for actions */
    .create-actions-hint {
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
      padding: 6px;
      background: var(--bg);
      border-radius: 8px;
    }
    .create-actions-hint.hidden { display: none; }
    
    .create-selected-spot {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(3,105,161,0.1);
      border: 1px solid rgba(3,105,161,0.2);
      border-radius: 10px;
    }
    .selected-spot-label {
      font-size: 10px;
      color: var(--text-muted);
    }
    .selected-spot-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
    }
    .selected-spot-clear {
      width: 18px; height: 18px;
      background: rgba(0,0,0,0.1);
      border: none;
      border-radius: 50%;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .spot-location-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: var(--bg);
      border-radius: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .spot-coords-label {
      font-size: 10px;
      color: var(--text-muted);
    }
    .spot-coords-value {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }
    .spot-reposition-btn {
      padding: 6px 10px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }
    .spot-reposition-btn:active {
      background: var(--bg);
    }
    
    .karma-requirement {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: rgba(22,163,74,0.1);
      border: 1px solid rgba(22,163,74,0.2);
      border-radius: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .karma-requirement.insufficient {
      background: rgba(239,68,68,0.1);
      border-color: rgba(239,68,68,0.2);
    }
    .karma-req-icon {
      font-size: 14px;
    }
    .karma-req-text {
      font-size: 11px;
      color: var(--text);
    }
    .karma-req-status {
      font-size: 10px;
      color: var(--favorable);
      margin-left: auto;
    }
    .karma-requirement.insufficient .karma-req-status {
      color: #ef4444;
    }
    
    /* Route Detail */
    .route-detail-map {
      height: 180px;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
      position: relative;
    }
    #routeDetailMap {
      width: 100%;
      height: 100%;
    }
    .route-stats { display: flex; gap: 8px; margin-bottom: 12px; }
    .route-stat {
      flex: 1; background: var(--white); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px; text-align: center;
    }
    .route-stat-value { font-size: 16px; font-weight: 800; color: var(--text); }
    .route-stat-label { font-size: 9px; color: var(--text-muted); margin-top: 2px; }
    
    /* Hide Leaflet zoom control */
    .leaflet-control-zoom { display: none; }
  </style>
</head>
<body>
  <div class="phone-frame">
    <div class="dynamic-island"></div>
    
    <div id="screen-explore" class="screen active">
      <div class="header">
        <div class="header-top">
          <div class="logo">
            <div class="logo-icon">üèä</div>
            <span class="logo-text">SwimSpot</span>
          </div>
        </div>
        <div class="search-bar">
          <span>üîç</span>
          <input type="text" placeholder="Rechercher...">
          <div class="location-buttons">
            <button class="location-btn active" onclick="goToLocation('marseille')">üìç Marseille</button>
            <button class="location-btn" onclick="goToLocation('wimereux')">üìç Wimereux</button>
          </div>
        </div>
      </div>
      
      <div class="map-container">
        <div id="map"></div>
        <div class="map-legend">
          <div class="legend-title">Conditions</div>
          <div class="legend-item"><div class="legend-dot favorable"></div><span class="legend-label">Favorables</span></div>
          <div class="legend-item"><div class="legend-dot technique"></div><span class="legend-label">Techniques</span></div>
          <div class="legend-item"><div class="legend-dot exigeant"></div><span class="legend-label">Exigeantes</span></div>
        </div>
      </div>
      
      <div class="previsions-panel">
        <div class="previsions-header">
          <span class="previsions-title">‚è±Ô∏è Pr√©visions</span>
          <span class="previsions-time" id="timeLabel">Maintenant</span>
        </div>
        <input type="range" class="previsions-slider" id="timeSlider" min="0" max="5" value="0">
        <div class="slider-labels">
          <span class="slider-label active">Now</span>
          <span class="slider-label">+2h</span>
          <span class="slider-label">+4h</span>
          <span class="slider-label">+6h</span>
          <span class="slider-label">+8h</span>
          <span class="slider-label">+24h</span>
        </div>
        <div class="previsions-hint"><span>üí°</span><span><strong>Glissez</strong> pour voir l'√©volution ‚Ä¢ <strong>D√©placez la carte</strong> pour explorer</span></div>
      </div>
      
      <div class="nav-bar">
        <button class="nav-item active"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Explore</span></button>
        <button class="nav-item" onclick="showScreen('create')"><span class="nav-icon">‚ûï</span><span class="nav-label">Add</span></button>
        <button class="nav-item" onclick="showScreen('profile')"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
      </div>
    </div>
    
    <div id="screen-spot" class="screen">
      <div class="spot-header">
        <div class="spot-header-top">
          <button class="spot-back" onclick="showScreen('explore')">‚Üê</button>
          <div class="spot-title">
            <div class="spot-name" id="detailSpotName">Plage du Prado</div>
            <div class="spot-location" id="detailSpotLocation">Marseille ¬∑ Maintenant</div>
          </div>
        </div>
        <div class="spot-status-bar">
          <div class="spot-status-badge" id="detailStatusBadge"><div class="legend-dot favorable"></div><span>Favorables</span></div>
          <div class="spot-status-badge" id="detailTempBadge"><span>üå°Ô∏è</span><span>19¬∞C</span></div>
        </div>
      </div>
      
      <div class="spot-content">
        <div class="status-hero favorable" id="detailStatusHero">
          <div class="status-hero-icon">‚úì</div>
          <div class="status-hero-content">
            <div class="status-hero-title">Conditions Favorables</div>
            <div class="status-hero-subtitle">Id√©al pour la nage ‚Äî Tous niveaux</div>
          </div>
        </div>
        
        <div class="disclaimer">‚ö†Ô∏è L'√©valuation finale appartient au nageur.</div>
        
        <div class="conditions-grid" id="detailConditions"></div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üó£Ô∏è Infos locales <span class="section-badge">3</span></div>
            <button class="section-action" onclick="openModal('modalAddInfo')">+ Ajouter</button>
          </div>
          
          <div class="karma-explainer" id="karmaExplainer">
            <div class="karma-explainer-title">‚≠ê Syst√®me Karma</div>
            <div class="karma-explainer-text">Les infos sont valid√©es par la communaut√©. Gagnez des points en contribuant !</div>
            <div class="karma-rules">
              <div class="karma-rule"><span class="karma-rule-points">+10</span><span>Ajouter une info</span></div>
              <div class="karma-rule"><span class="karma-rule-points">+5</span><span>V√©rifier une info</span></div>
              <div class="karma-rule"><span class="karma-rule-points">+25</span><span>Cr√©er un parcours</span></div>
            </div>
          </div>
          
          <div class="local-card">
            <div class="local-card-header">
              <div class="local-card-icon tip">üí°</div>
              <div class="local-card-title">Meilleur cr√©neau</div>
              <div class="local-card-badge">V√©rifi√© √ó12</div>
            </div>
            <div class="local-card-desc">T√¥t le matin (6h-8h) pour une eau calme.</div>
            <div class="local-card-footer">
              <div class="local-card-karma">Par <strong>@MarineLuc</strong> <span class="karma-badge" onclick="toggleKarma()">127 ‚≠ê</span></div>
              <button class="verify-btn" onclick="verifyInfo(this)">‚úì V√©rifier</button>
            </div>
          </div>
          
          <div class="local-card">
            <div class="local-card-header">
              <div class="local-card-icon warning">‚ö†Ô∏è</div>
              <div class="local-card-title">Zone jet-ski</div>
              <div class="local-card-badge">V√©rifi√© √ó8</div>
            </div>
            <div class="local-card-desc">Rester √† gauche de la bou√©e jaune.</div>
            <div class="local-card-footer">
              <div class="local-card-karma">Par <strong>@SwimPro13</strong> <span class="karma-badge" onclick="toggleKarma()">89 ‚≠ê</span></div>
              <button class="verify-btn" onclick="verifyInfo(this)">‚úì V√©rifier</button>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üß≠ Parcours <span class="section-badge">2</span></div>
            <button class="section-action" onclick="openModal('modalAddRoute')">+ Cr√©er</button>
          </div>
          <div class="route-card" onclick="openRoute('triangle', 'Triangle des bou√©es', '0.8', 'D√©butant', 45, 'Parcours triangulaire balis√© par 3 bou√©es jaunes. Id√©al pour s\'entra√Æner en s√©curit√©.')">
            <div class="route-card-header">
              <div class="route-distance"><div class="route-distance-value">0.8</div><div class="route-distance-unit">km</div></div>
              <div class="route-info"><div class="route-name">Triangle des bou√©es</div><div class="route-meta">D√©butant ¬∑ 45 nages</div></div>
              <span class="route-arrow">‚Ä∫</span>
            </div>
          </div>
          <div class="route-card" onclick="openRoute('prado-david', 'Prado ‚Üí David', '1.5', 'Interm√©diaire', 23, 'Travers√©e c√¥ti√®re le long de la corniche. Quelques zones de courant. Vue magnifique.')">
            <div class="route-card-header">
              <div class="route-distance"><div class="route-distance-value">1.5</div><div class="route-distance-unit">km</div></div>
              <div class="route-info"><div class="route-name">Prado ‚Üí David</div><div class="route-meta">Interm√©diaire ¬∑ 23 nages</div></div>
              <span class="route-arrow">‚Ä∫</span>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header"><div class="section-title">üìä Sources</div></div>
          <div class="sources-grid">
            <div class="source-card"><div class="source-name">M√©t√©o France</div><div class="source-desc">Vent, temp√©rature</div></div>
            <div class="source-card"><div class="source-name">SHOM</div><div class="source-desc">Mar√©es, courants</div></div>
            <div class="source-card"><div class="source-name">Copernicus</div><div class="source-desc">Temp√©rature eau</div></div>
            <div class="source-card"><div class="source-name">Communaut√©</div><div class="source-desc">Infos locales</div></div>
          </div>
        </div>
      </div>
      
      <div class="nav-bar">
        <button class="nav-item active" onclick="showScreen('explore')"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Explore</span></button>
        <button class="nav-item" onclick="showScreen('create')"><span class="nav-icon">‚ûï</span><span class="nav-label">Add</span></button>
        <button class="nav-item" onclick="showScreen('profile')"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
      </div>
    </div>
    
    <!-- ROUTE DETAIL SCREEN -->
    <div id="screen-route" class="screen">
      <div class="spot-header">
        <div class="spot-header-top">
          <button class="spot-back" onclick="backToSpot()">‚Üê</button>
          <div class="spot-title">
            <div class="spot-name" id="routeName">Triangle des bou√©es</div>
            <div class="spot-location" id="routeLocation">Plages du Prado</div>
          </div>
        </div>
        <div class="spot-status-bar">
          <div class="spot-status-badge"><span>üìè</span><span id="routeDistanceBadge">0.8 km</span></div>
          <div class="spot-status-badge"><span>üë•</span><span id="routeSwimsBadge">45 nages</span></div>
        </div>
      </div>
      
      <div class="spot-content">
        <div class="route-detail-map">
          <div id="routeDetailMap"></div>
        </div>
        
        <div class="route-stats">
          <div class="route-stat">
            <div class="route-stat-value" id="routeDuration">~20 min</div>
            <div class="route-stat-label">Dur√©e estim√©e</div>
          </div>
          <div class="route-stat">
            <div class="route-stat-value">‚≠ê</div>
            <div class="route-stat-label" id="routeLevel">D√©butant</div>
          </div>
          <div class="route-stat">
            <div class="route-stat-value">@Luc</div>
            <div class="route-stat-label">Cr√©ateur</div>
          </div>
        </div>
        
        <div class="disclaimer">‚ö†Ô∏è V√©rifiez les conditions avant de partir.</div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üìù Description</div>
          </div>
          <div class="local-card">
            <div class="local-card-desc" id="routeDesc">Parcours triangulaire balis√© par 3 bou√©es jaunes. Id√©al pour s'entra√Æner en s√©curit√©.</div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-header">
            <div class="section-title">üí° Conseils</div>
          </div>
          <div class="local-card">
            <div class="local-card-header">
              <div class="local-card-icon tip">üí°</div>
              <div class="local-card-title">Partir avec le courant</div>
            </div>
            <div class="local-card-desc">Commencer par la bou√©e Est le matin.</div>
          </div>
        </div>
      </div>
      
      <div class="nav-bar">
        <button class="nav-item" onclick="showScreen('explore')"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Explore</span></button>
        <button class="nav-item"><span class="nav-icon">‚ûï</span><span class="nav-label">Add</span></button>
        <button class="nav-item" onclick="showScreen('profile')"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
      </div>
    </div>
    
    <div id="screen-profile" class="screen">
      <div class="header"><div class="header-top"><div class="logo"><div class="logo-icon">üë§</div><span class="logo-text">Mon Profil</span></div></div></div>
      <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:20px;">
        <div style="text-align:center;color:var(--text-muted);">
          <div style="font-size:48px;margin-bottom:16px;">üèä</div>
          <div style="font-size:20px;font-weight:800;color:var(--text);margin-bottom:8px;">@SwimmerLuc</div>
          <div style="margin-bottom:24px;">France</div>
          <div style="display:flex;gap:32px;justify-content:center;">
            <div><div style="font-size:28px;font-weight:800;color:var(--text);" data-karma-display>127</div><div style="font-size:11px;">Karma ‚≠ê</div></div>
            <div><div style="font-size:28px;font-weight:800;color:var(--text);">5</div><div style="font-size:11px;">Parcours</div></div>
            <div><div style="font-size:28px;font-weight:800;color:var(--text);">12</div><div style="font-size:11px;">Infos</div></div>
          </div>
        </div>
      </div>
      <div class="nav-bar">
        <button class="nav-item" onclick="showScreen('explore')"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Explore</span></button>
        <button class="nav-item" onclick="showScreen('create')"><span class="nav-icon">‚ûï</span><span class="nav-label">Add</span></button>
        <button class="nav-item active"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
      </div>
    </div>
    
    <div id="screen-create" class="screen">
      <div class="create-map-container">
        <div id="createMap"></div>
        <div class="create-map-header">
          <button class="create-back-btn" onclick="showScreen('explore')">‚Üê</button>
          <div class="create-title">Ajouter</div>
          <div class="create-search">
            <input type="text" placeholder="üîç Rechercher un lieu..." id="createSearchInput">
          </div>
        </div>
        <div class="create-hint" id="createHint">üëÜ S√©lectionnez un spot ou cliquez pour en cr√©er un</div>
        <div class="create-coords" id="createCoords" style="display:none;">
          <span id="createCoordsText">43.2610, 5.3750</span>
          <button class="coords-clear" onclick="clearCreateMarker()">‚úï</button>
        </div>
      </div>
      
      <div class="create-actions" id="createActions">
        <div class="create-actions-title">Que souhaitez-vous ajouter ?</div>
        <div class="create-actions-grid">
          <button class="create-action-btn disabled" onclick="startCreateSpot()" id="btnCreateSpot">
            <div class="create-action-icon spot">üìç</div>
            <div class="create-action-label">Nouveau spot</div>
            <div class="create-action-karma">+20 ‚≠ê</div>
          </button>
          <button class="create-action-btn disabled" onclick="startCreateInfo('tip')" id="btnCreateInfo">
            <div class="create-action-icon info">üí°</div>
            <div class="create-action-label">Info locale</div>
            <div class="create-action-karma">+10 ‚≠ê</div>
          </button>
          <button class="create-action-btn disabled" onclick="startCreateInfo('danger')" id="btnCreateDanger">
            <div class="create-action-icon danger">üö®</div>
            <div class="create-action-label">Danger</div>
            <div class="create-action-karma">+15 ‚≠ê</div>
          </button>
          <button class="create-action-btn disabled" onclick="startCreateRoute()" id="btnCreateRoute">
            <div class="create-action-icon route">üß≠</div>
            <div class="create-action-label">Parcours</div>
            <div class="create-action-karma">+25 ‚≠ê</div>
          </button>
        </div>
        <div class="create-actions-hint" id="createActionsHint">üìç Cliquez sur un spot existant ou cr√©ez-en un nouveau</div>
        <div class="create-selected-spot" id="createSelectedSpot" style="display:none;">
          <span class="selected-spot-label">Spot s√©lectionn√©:</span>
          <span class="selected-spot-name" id="selectedSpotName">Catalans</span>
          <button class="selected-spot-clear" onclick="clearSelectedSpot()">‚úï</button>
        </div>
      </div>
      
      <div class="nav-bar">
        <button class="nav-item" onclick="showScreen('explore')"><span class="nav-icon">üó∫Ô∏è</span><span class="nav-label">Explore</span></button>
        <button class="nav-item active"><span class="nav-icon">‚ûï</span><span class="nav-label">Add</span></button>
        <button class="nav-item" onclick="showScreen('profile')"><span class="nav-icon">üë§</span><span class="nav-label">Profile</span></button>
      </div>
      
      <!-- Inline forms that appear after location selection -->
      <div class="create-form-panel" id="createFormSpot" style="display:none;">
        <div class="create-form-header">
          <button class="create-form-back" onclick="cancelCreateSpot()">‚Üê</button>
          <div class="create-form-title">üìç Nouveau spot</div>
        </div>
        <div class="create-form-content">
          <div class="spot-location-info">
            <span class="spot-coords-label">Position:</span>
            <span class="spot-coords-value" id="newSpotCoords">43.2610, 5.3750</span>
            <button class="spot-reposition-btn" onclick="repositionSpot()">üéØ Repositionner</button>
          </div>
          <div class="karma-requirement" id="karmaRequirement">
            <span class="karma-req-icon">‚≠ê</span>
            <span class="karma-req-text">Minimum <strong>50 karma</strong> requis</span>
            <span class="karma-req-status" id="karmaReqStatus">‚úì Vous avez 127 karma</span>
          </div>
          <div class="form-group">
            <label>Nom du spot</label>
            <input type="text" id="newSpotName" placeholder="Ex: Plage des Catalans">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="newSpotDesc" placeholder="D√©crivez ce spot..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Type</label>
              <select id="newSpotType">
                <option value="plage">Plage</option>
                <option value="crique">Crique</option>
                <option value="port">Port</option>
                <option value="lac">Lac</option>
              </select>
            </div>
            <div class="form-group">
              <label>Acc√®s</label>
              <select id="newSpotAccess">
                <option value="facile">Facile</option>
                <option value="modere">Mod√©r√©</option>
                <option value="difficile">Difficile</option>
              </select>
            </div>
          </div>
          <button class="modal-submit" onclick="submitNewSpot()">Cr√©er le spot (+20 karma ‚≠ê)</button>
        </div>
      </div>
      
      <div class="create-form-panel" id="createFormInfo" style="display:none;">
        <div class="create-form-header">
          <button class="create-form-back" onclick="hideCreateForm()">‚Üê</button>
          <div class="create-form-title" id="createFormInfoTitle">üí° Info locale</div>
        </div>
        <div class="create-form-content">
          <div class="type-selector">
            <button class="type-btn active" onclick="selectCreateInfoType(this, 'tip')">
              <div class="type-btn-icon">üí°</div>
              <div class="type-btn-label">Conseil</div>
            </button>
            <button class="type-btn" onclick="selectCreateInfoType(this, 'warning')">
              <div class="type-btn-icon">‚ö†Ô∏è</div>
              <div class="type-btn-label">Attention</div>
            </button>
            <button class="type-btn" onclick="selectCreateInfoType(this, 'danger')">
              <div class="type-btn-icon">üö®</div>
              <div class="type-btn-label">Danger</div>
            </button>
          </div>
          <div class="form-group">
            <label>Titre</label>
            <input type="text" id="newInfoTitle" placeholder="Ex: Zone de courants">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="newInfoDesc" placeholder="D√©crivez cette information..."></textarea>
          </div>
          <button class="modal-submit" onclick="submitNewInfo()">Publier (+10 karma ‚≠ê)</button>
        </div>
      </div>
      
      <div class="create-form-panel" id="createFormRoute" style="display:none;">
        <div class="create-form-header">
          <button class="create-form-back" onclick="hideCreateForm()">‚Üê</button>
          <div class="create-form-title">üß≠ Tracer un parcours</div>
        </div>
        <div class="create-form-content">
          <div class="route-draw-hint">
            <span id="routeDrawHint">üëÜ Cliquez sur la carte pour tracer</span>
            <span class="route-draw-distance" id="routeDrawDistance">0.00 km</span>
          </div>
          <div class="route-draw-toolbar">
            <button class="toolbar-btn" onclick="undoCreateRoutePoint()">‚Ü©Ô∏è Annuler</button>
            <button class="toolbar-btn" onclick="clearCreateRoutePoints()">üóëÔ∏è Effacer</button>
            <button class="toolbar-btn primary" onclick="closeCreateRouteLoop()" id="closeCreateLoopBtn" style="display:none;">üîÑ Boucler</button>
          </div>
          <div class="form-row" style="margin-top:10px;">
            <div class="form-group">
              <label>Nom</label>
              <input type="text" id="newRouteName" placeholder="Triangle des bou√©es">
            </div>
            <div class="form-group" style="max-width:90px;">
              <label>Niveau</label>
              <select id="newRouteLevel">
                <option value="debutant">D√©butant</option>
                <option value="inter">Inter.</option>
                <option value="avance">Avanc√©</option>
              </select>
            </div>
          </div>
          <button class="modal-submit" onclick="submitNewRoute()">Cr√©er le parcours (+25 karma ‚≠ê)</button>
        </div>
      </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- MODAL: Ajouter Info (inside phone) -->
    <div class="modal-overlay" id="modalAddInfo">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">üí° Ajouter une info</div>
          <button class="modal-close" onclick="closeModal('modalAddInfo')">√ó</button>
        </div>
        <div class="type-selector">
          <button class="type-btn active" onclick="selectInfoType(this, 'tip')">
            <div class="type-btn-icon">üí°</div>
            <div class="type-btn-label">Conseil</div>
          </button>
          <button class="type-btn" onclick="selectInfoType(this, 'warning')">
            <div class="type-btn-icon">‚ö†Ô∏è</div>
            <div class="type-btn-label">Attention</div>
          </button>
          <button class="type-btn" onclick="selectInfoType(this, 'danger')">
            <div class="type-btn-icon">üö®</div>
            <div class="type-btn-label">Danger</div>
          </button>
        </div>
        <div class="modal-form">
          <div class="form-group">
            <label>Titre</label>
            <input type="text" id="infoTitle" placeholder="Ex: Meilleur cr√©neau">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="infoDesc" placeholder="D√©crivez votre info..."></textarea>
          </div>
          <button class="modal-submit" onclick="submitInfo()">Publier (+10 karma ‚≠ê)</button>
        </div>
      </div>
    </div>
    
    <!-- MODAL: Cr√©er Parcours avec carte (inside phone) -->
    <div class="modal-overlay" id="modalAddRoute">
      <div class="modal-content modal-fullscreen">
        <div class="modal-header">
          <div class="modal-title">üß≠ Tracer un parcours</div>
          <button class="modal-close" onclick="closeModal('modalAddRoute')">√ó</button>
        </div>
        <div class="route-map-container">
          <div id="routeMapDraw"></div>
          <div class="route-map-hint" id="routeHint">üëÜ Tracez votre boucle sur l'eau</div>
          <div class="route-points-count" id="routePointsCount">0 points</div>
          <div class="route-map-toolbar">
            <button class="toolbar-btn" onclick="undoRoutePoint()">‚Ü©Ô∏è Annuler</button>
            <button class="toolbar-btn" onclick="clearRoutePoints()">üóëÔ∏è Effacer</button>
          </div>
          <div class="route-distance-display"><span id="routeDistanceLive">0.00</span> km</div>
        </div>
        <div class="route-info-box">üîÑ Les parcours sont toujours des boucles (retour au d√©part)</div>
        <div class="modal-form compact">
          <div class="form-row">
            <div class="form-group">
              <label>Nom</label>
              <input type="text" id="routeTitle" placeholder="Triangle des bou√©es">
            </div>
            <div class="form-group" style="max-width:100px;">
              <label>Niveau</label>
              <select id="routeLevelInput">
                <option value="debutant">D√©butant</option>
                <option value="intermediaire">Inter.</option>
                <option value="avance">Avanc√©</option>
              </select>
            </div>
          </div>
          <button class="modal-submit" onclick="submitRoute()">Cr√©er le parcours (+25 karma ‚≠ê)</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============== SPOTS DATA ==============
    // Marseille area spots (GPS coordinates)
    var spots = [
      // MARSEILLE REGION
      { id: 'catalans', name: 'Catalans', region: 'Marseille',
        lat: 43.2905, lng: 5.3545,
        conditions: [
          { status: 'favorable', temp: 18, wind: 10, waves: 0.2 },
          { status: 'favorable', temp: 18, wind: 12, waves: 0.3 },
          { status: 'favorable', temp: 18, wind: 14, waves: 0.4 },
          { status: 'technique', temp: 17, wind: 18, waves: 0.5 },
          { status: 'favorable', temp: 17, wind: 8, waves: 0.2 },
          { status: 'favorable', temp: 18, wind: 6, waves: 0.1 }
        ]
      },
      { id: 'prado', name: 'Plages du Prado', region: 'Marseille',
        lat: 43.2610, lng: 5.3750,
        conditions: [
          { status: 'favorable', temp: 19, wind: 12, waves: 0.3 },
          { status: 'favorable', temp: 19, wind: 14, waves: 0.4 },
          { status: 'technique', temp: 18, wind: 18, waves: 0.6 },
          { status: 'technique', temp: 18, wind: 20, waves: 0.7 },
          { status: 'favorable', temp: 18, wind: 10, waves: 0.3 },
          { status: 'favorable', temp: 19, wind: 8, waves: 0.2 }
        ]
      },
      { id: 'pointe-rouge', name: 'Pointe Rouge', region: 'Marseille',
        lat: 43.2450, lng: 5.3680,
        conditions: [
          { status: 'technique', temp: 17, wind: 18, waves: 0.5 },
          { status: 'technique', temp: 17, wind: 20, waves: 0.6 },
          { status: 'exigeant', temp: 16, wind: 25, waves: 0.9 },
          { status: 'exigeant', temp: 16, wind: 28, waves: 1.1 },
          { status: 'technique', temp: 17, wind: 15, waves: 0.5 },
          { status: 'favorable', temp: 18, wind: 10, waves: 0.3 }
        ]
      },
      { id: 'sormiou', name: 'Calanque Sormiou', region: 'Marseille',
        lat: 43.2100, lng: 5.4180,
        conditions: [
          { status: 'favorable', temp: 18, wind: 8, waves: 0.2 },
          { status: 'favorable', temp: 18, wind: 10, waves: 0.3 },
          { status: 'favorable', temp: 17, wind: 12, waves: 0.3 },
          { status: 'technique', temp: 17, wind: 16, waves: 0.5 },
          { status: 'favorable', temp: 17, wind: 6, waves: 0.2 },
          { status: 'favorable', temp: 18, wind: 5, waves: 0.1 }
        ]
      },
      { id: 'envau', name: 'Calanque En-Vau', region: 'Marseille',
        lat: 43.2020, lng: 5.4950,
        conditions: [
          { status: 'favorable', temp: 18, wind: 6, waves: 0.2 },
          { status: 'favorable', temp: 18, wind: 8, waves: 0.2 },
          { status: 'favorable', temp: 17, wind: 10, waves: 0.3 },
          { status: 'technique', temp: 17, wind: 14, waves: 0.4 },
          { status: 'favorable', temp: 17, wind: 5, waves: 0.1 },
          { status: 'favorable', temp: 18, wind: 4, waves: 0.1 }
        ]
      },
      { id: 'cassis', name: 'Cassis', region: 'Marseille',
        lat: 43.2140, lng: 5.5370,
        conditions: [
          { status: 'technique', temp: 17, wind: 14, waves: 0.5 },
          { status: 'technique', temp: 17, wind: 16, waves: 0.6 },
          { status: 'exigeant', temp: 16, wind: 22, waves: 0.9 },
          { status: 'exigeant', temp: 16, wind: 24, waves: 1.0 },
          { status: 'technique', temp: 17, wind: 12, waves: 0.4 },
          { status: 'favorable', temp: 18, wind: 8, waves: 0.3 }
        ]
      },
      { id: 'frioul', name: '√éles du Frioul', region: 'Marseille',
        lat: 43.2795, lng: 5.3100,
        conditions: [
          { status: 'technique', temp: 17, wind: 16, waves: 0.6 },
          { status: 'exigeant', temp: 17, wind: 22, waves: 0.8 },
          { status: 'exigeant', temp: 16, wind: 26, waves: 1.0 },
          { status: 'exigeant', temp: 16, wind: 24, waves: 0.9 },
          { status: 'technique', temp: 17, wind: 14, waves: 0.5 },
          { status: 'favorable', temp: 18, wind: 10, waves: 0.3 }
        ]
      },
      
      // WIMEREUX / C√îTE D'OPALE REGION
      { id: 'wimereux', name: 'Plage de Wimereux', region: 'Wimereux',
        lat: 50.7680, lng: 1.6130,
        conditions: [
          { status: 'technique', temp: 14, wind: 20, waves: 0.8 },
          { status: 'technique', temp: 14, wind: 22, waves: 0.9 },
          { status: 'exigeant', temp: 13, wind: 28, waves: 1.2 },
          { status: 'exigeant', temp: 13, wind: 30, waves: 1.4 },
          { status: 'technique', temp: 14, wind: 16, waves: 0.6 },
          { status: 'favorable', temp: 15, wind: 12, waves: 0.4 }
        ]
      },
      { id: 'boulogne', name: 'Boulogne-sur-Mer', region: 'Wimereux',
        lat: 50.7260, lng: 1.5980,
        conditions: [
          { status: 'technique', temp: 14, wind: 18, waves: 0.7 },
          { status: 'exigeant', temp: 14, wind: 24, waves: 1.0 },
          { status: 'exigeant', temp: 13, wind: 30, waves: 1.3 },
          { status: 'exigeant', temp: 13, wind: 32, waves: 1.5 },
          { status: 'technique', temp: 14, wind: 14, waves: 0.5 },
          { status: 'technique', temp: 15, wind: 10, waves: 0.4 }
        ]
      },
      { id: 'cap-blanc-nez', name: 'Cap Blanc-Nez', region: 'Wimereux',
        lat: 50.9290, lng: 1.7070,
        conditions: [
          { status: 'exigeant', temp: 13, wind: 25, waves: 1.1 },
          { status: 'exigeant', temp: 13, wind: 28, waves: 1.3 },
          { status: 'exigeant', temp: 12, wind: 35, waves: 1.8 },
          { status: 'exigeant', temp: 12, wind: 32, waves: 1.6 },
          { status: 'exigeant', temp: 13, wind: 22, waves: 1.0 },
          { status: 'technique', temp: 14, wind: 16, waves: 0.7 }
        ]
      },
      { id: 'le-touquet', name: 'Le Touquet', region: 'Wimereux',
        lat: 50.5210, lng: 1.5850,
        conditions: [
          { status: 'favorable', temp: 15, wind: 14, waves: 0.5 },
          { status: 'technique', temp: 15, wind: 18, waves: 0.7 },
          { status: 'technique', temp: 14, wind: 22, waves: 0.9 },
          { status: 'exigeant', temp: 14, wind: 26, waves: 1.1 },
          { status: 'favorable', temp: 15, wind: 10, waves: 0.4 },
          { status: 'favorable', temp: 16, wind: 8, waves: 0.3 }
        ]
      },
      { id: 'wissant', name: 'Wissant', region: 'Wimereux',
        lat: 50.8870, lng: 1.6650,
        conditions: [
          { status: 'technique', temp: 14, wind: 16, waves: 0.6 },
          { status: 'technique', temp: 14, wind: 20, waves: 0.8 },
          { status: 'exigeant', temp: 13, wind: 26, waves: 1.1 },
          { status: 'exigeant', temp: 13, wind: 28, waves: 1.2 },
          { status: 'technique', temp: 14, wind: 12, waves: 0.5 },
          { status: 'favorable', temp: 15, wind: 8, waves: 0.3 }
        ]
      }
    ];
    
    var timeOffsets = [0, 2, 4, 6, 8, 24]; // hours from now
    var currentTime = 0;
    var currentSpotId = null;
    var currentSpotName = '';
    var map = null;
    var markers = [];
    
    // User karma system
    var userKarma = 127; // Current user karma
    var KARMA_REQUIRED_SPOT = 50; // Minimum karma to create a spot
    var nextSpotId = 100; // For generating new spot IDs
    
    var locations = {
      marseille: { lat: 43.25, lng: 5.40, zoom: 11 },
      wimereux: { lat: 50.75, lng: 1.65, zoom: 10 }
    };
    
    function getTimeLabel(offsetIndex) {
      var now = new Date();
      var offset = timeOffsets[offsetIndex];
      var futureTime = new Date(now.getTime() + offset * 60 * 60 * 1000);
      
      var days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
      var day = days[futureTime.getDay()];
      var date = futureTime.getDate();
      var hours = futureTime.getHours().toString().padStart(2, '0');
      var minutes = futureTime.getMinutes().toString().padStart(2, '0');
      
      return day + ' ' + date + ' ¬∑ ' + hours + ':' + minutes;
    }
    
    // ============== MAP INITIALIZATION ==============
    function initMap() {
      map = L.map('map', {
        center: [locations.marseille.lat, locations.marseille.lng],
        zoom: locations.marseille.zoom,
        zoomControl: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(map);
      
      createMarkers(currentTime);
    }
    
    function createMarkerIcon(spot, timeIndex) {
      var cond = spot.conditions[timeIndex];
      var html = '<div class="custom-marker">' +
        '<div class="marker-temp">' + cond.temp + '¬∞C</div>' +
        '<div class="marker-pin ' + cond.status + '"></div>' +
        '<div class="marker-name">' + spot.name + '</div>' +
      '</div>';
      
      return L.divIcon({
        className: '',
        html: html,
        iconSize: [80, 70],
        iconAnchor: [40, 60]
      });
    }
    
    function createMarkers(timeIndex) {
      // Clear existing markers
      markers.forEach(function(m) { map.removeLayer(m.marker); });
      markers = [];
      
      spots.forEach(function(spot) {
        var icon = createMarkerIcon(spot, timeIndex);
        var marker = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map);
        
        marker.on('click', function() {
          openSpot(spot.id);
        });
        
        markers.push({ marker: marker, spot: spot });
      });
    }
    
    function updateMarkers(newTimeIndex) {
      markers.forEach(function(item) {
        var spot = item.spot;
        var marker = item.marker;
        var oldCond = spot.conditions[currentTime];
        var newCond = spot.conditions[newTimeIndex];
        
        var newIcon = createMarkerIcon(spot, newTimeIndex);
        marker.setIcon(newIcon);
      });
    }
    
    function goToLocation(locationId) {
      var loc = locations[locationId];
      map.flyTo([loc.lat, loc.lng], loc.zoom, { duration: 1.5 });
      
      // Update buttons
      document.querySelectorAll('.location-btn').forEach(function(btn) {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
    }
    
    // ============== SPOT DETAIL ==============
    function openSpot(spotId) {
      var spot = spots.find(function(s) { return s.id === spotId; });
      if (!spot) return;
      
      var cond = spot.conditions[currentTime];
      var statusLabels = { favorable: 'Favorables', technique: 'Techniques', exigeant: 'Exigeantes' };
      var heroData = {
        favorable: { icon: '‚úì', title: 'Conditions Favorables', sub: 'Id√©al pour tous niveaux' },
        technique: { icon: '!', title: 'Conditions Techniques', sub: 'Nageurs exp√©riment√©s' },
        exigeant: { icon: '‚úï', title: 'Conditions Exigeantes', sub: 'Fortement d√©conseill√©' }
      };
      
      document.getElementById('detailSpotName').textContent = spot.name;
      document.getElementById('detailSpotLocation').textContent = spot.region + ' ¬∑ ' + getTimeLabel(currentTime);
      document.getElementById('detailStatusBadge').innerHTML = '<div class="legend-dot ' + cond.status + '"></div><span>' + statusLabels[cond.status] + '</span>';
      document.getElementById('detailTempBadge').innerHTML = '<span>üå°Ô∏è</span><span>' + cond.temp + '¬∞C</span>';
      
      var hero = document.getElementById('detailStatusHero');
      hero.className = 'status-hero ' + cond.status;
      hero.innerHTML = '<div class="status-hero-icon">' + heroData[cond.status].icon + '</div><div class="status-hero-content"><div class="status-hero-title">' + heroData[cond.status].title + '</div><div class="status-hero-subtitle">' + heroData[cond.status].sub + '</div></div>';
      
      var windDesc = cond.wind < 12 ? 'Calme' : cond.wind < 20 ? 'Mod√©r√©' : 'Fort';
      var wavesDesc = cond.waves < 0.4 ? 'Calme' : cond.waves < 0.7 ? 'Clapot' : 'Agit√©e';
      var tempClass = cond.temp < 15 ? ' warning' : '';
      var windClass = cond.wind > 20 ? ' danger' : cond.wind > 15 ? ' warning' : '';
      var wavesClass = cond.waves > 0.8 ? ' danger' : cond.waves > 0.5 ? ' warning' : '';
      
      // Determine jellyfish and currents based on conditions
      var jellyfishRisk = cond.temp > 17 && cond.waves < 0.5 ? 'Possible' : 'Faible';
      var jellyfishClass = jellyfishRisk === 'Possible' ? ' warning' : '';
      var currentsRisk = cond.wind > 18 || cond.waves > 0.7 ? 'Forts' : cond.wind > 12 ? 'Mod√©r√©s' : 'Faibles';
      var currentsClass = currentsRisk === 'Forts' ? ' danger' : currentsRisk === 'Mod√©r√©s' ? ' warning' : '';
      
      document.getElementById('detailConditions').innerHTML =
        '<div class="condition-card' + tempClass + '"><div class="condition-label">üå°Ô∏è Eau</div><div class="condition-value">' + cond.temp + '¬∞C</div><div class="condition-desc">' + (cond.temp >= 18 ? 'Confort' : 'Fra√Æche') + '</div></div>' +
        '<div class="condition-card' + windClass + '"><div class="condition-label">üí® Vent</div><div class="condition-value">' + cond.wind + '</div><div class="condition-desc">km/h ¬∑ ' + windDesc + '</div></div>' +
        '<div class="condition-card' + wavesClass + '"><div class="condition-label">üåä Vagues</div><div class="condition-value">' + cond.waves + 'm</div><div class="condition-desc">' + wavesDesc + '</div></div>' +
        '<div class="condition-card"><div class="condition-label">üåô Mar√©e</div><div class="condition-value">‚Üó</div><div class="condition-desc">Montante</div></div>' +
        '<div class="condition-card' + jellyfishClass + '"><div class="condition-label">üéê M√©duses</div><div class="condition-value">' + jellyfishRisk + '</div><div class="condition-desc">Risque</div></div>' +
        '<div class="condition-card' + currentsClass + '"><div class="condition-label">üåÄ Courants</div><div class="condition-value">' + currentsRisk + '</div><div class="condition-desc">Intensit√©</div></div>';
      
      // Hide karma explainer when opening new spot
      document.getElementById('karmaExplainer').classList.remove('show');
      
      // Save current spot for navigation
      currentSpotId = spotId;
      currentSpotName = spot.name;
      
      showScreen('spot');
      
      // Scroll to top of spot content
      setTimeout(function() {
        var spotContent = document.querySelector('#screen-spot .spot-content');
        if (spotContent) spotContent.scrollTop = 0;
      }, 50);
    }
    
    function toggleKarma() {
      var explainer = document.getElementById('karmaExplainer');
      explainer.classList.toggle('show');
    }
    
    // ============== NAVIGATION ==============
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
      document.getElementById('screen-' + id).classList.add('active');
      
      if (id === 'explore' && map) {
        setTimeout(function() { map.invalidateSize(); }, 100);
      }
      
      if (id === 'create') {
        setTimeout(function() {
          initCreateMap();
          if (createMap) {
            createMap.invalidateSize();
          }
          
          // Reset state
          createMode = null;
          selectedSpotId = null;
          if (createMarker) {
            createMap.removeLayer(createMarker);
            createMarker = null;
          }
          createLocation = null;
          clearCreateRoutePoints();
          
          // Reset UI
          document.getElementById('createActions').style.display = 'block';
          document.getElementById('createFormSpot').style.display = 'none';
          document.getElementById('createFormInfo').style.display = 'none';
          document.getElementById('createFormRoute').style.display = 'none';
          document.getElementById('createHint').style.display = 'block';
          document.getElementById('createHint').textContent = 'üëÜ S√©lectionnez un spot ou cliquez pour en cr√©er un';
          document.getElementById('createCoords').style.display = 'none';
          document.getElementById('createSelectedSpot').style.display = 'none';
          document.getElementById('createActionsHint').textContent = 'üìç Cliquez sur un spot existant ou cr√©ez-en un nouveau';
          document.getElementById('createActionsHint').style.display = 'block';
          
          // All buttons disabled by default
          document.getElementById('btnCreateSpot').classList.add('disabled');
          document.getElementById('btnCreateInfo').classList.add('disabled');
          document.getElementById('btnCreateDanger').classList.add('disabled');
          document.getElementById('btnCreateRoute').classList.add('disabled');
        }, 100);
      }
    }
    
    function verifyInfo(btn) {
      btn.classList.add('verified');
      btn.textContent = '‚úì V√©rifi√©';
      showToast('Merci ! +5 karma ‚≠ê');
    }
    
    function showToast(msg) {
      var t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(function() { t.classList.remove('show'); }, 2500);
    }
    
    // ============== MODALS ==============
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
      
      // Initialize route drawing map when opening route modal
      if (modalId === 'modalAddRoute') {
        setTimeout(function() {
          initRouteDrawMap();
          if (routeDrawMap) {
            routeDrawMap.invalidateSize();
            // Center on current spot
            if (currentSpotId) {
              var spot = spots.find(function(s) { return s.id === currentSpotId; });
              if (spot) routeDrawMap.setView([spot.lat, spot.lng], 15);
            }
          }
          // Reset UI state
          updateRouteUI();
        }, 100);
      }
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      
      // Clear route drawing when closing route modal
      if (modalId === 'modalAddRoute' && routeDrawMap) {
        clearRoutePoints();
      }
    }
    
    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(function(modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          modal.classList.remove('show');
        }
      });
    });
    
    function selectInfoType(btn, type) {
      document.querySelectorAll('.type-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
    }
    
    function submitInfo() {
      var title = document.getElementById('infoTitle').value;
      var desc = document.getElementById('infoDesc').value;
      if (!title || !desc) {
        showToast('Remplissez tous les champs');
        return;
      }
      closeModal('modalAddInfo');
      showToast('Info publi√©e ! +10 karma ‚≠ê');
      document.getElementById('infoTitle').value = '';
      document.getElementById('infoDesc').value = '';
    }
    
    function submitRoute() {
      var title = document.getElementById('routeTitle').value;
      if (!title) {
        showToast('Donnez un nom au parcours');
        return;
      }
      if (routePoints.length < 2) {
        showToast('Tracez au moins 2 points');
        return;
      }
      closeModal('modalAddRoute');
      showToast('Parcours cr√©√© ! +25 karma ‚≠ê');
      document.getElementById('routeTitle').value = '';
    }
    
    // ============== ROUTE DRAWING (Modal) ==============
    var routeDrawMap = null;
    var routePoints = [];
    var routeMarkers = [];
    var routePolyline = null;
    
    function initRouteDrawMap() {
      if (routeDrawMap) return;
      
      var container = document.getElementById('routeMapDraw');
      if (!container) return;
      
      // Get current spot location or default to Marseille (in water)
      var center = [43.255, 5.37];
      if (currentSpotId) {
        var spot = spots.find(function(s) { return s.id === currentSpotId; });
        if (spot) center = [spot.lat - 0.005, spot.lng]; // Offset south into water
      }
      
      routeDrawMap = L.map('routeMapDraw', {
        center: center,
        zoom: 15,
        zoomControl: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
      }).addTo(routeDrawMap);
      
      routeDrawMap.on('click', function(e) {
        addRoutePoint(e.latlng);
      });
    }
    
    function addRoutePoint(latlng) {
      routePoints.push(latlng);
      
      var pointNumber = routePoints.length;
      var marker = L.circleMarker(latlng, {
        radius: 10,
        fillColor: pointNumber === 1 ? '#16a34a' : '#0369a1',
        color: 'white',
        weight: 3,
        fillOpacity: 1
      }).addTo(routeDrawMap);
      
      // Add number label
      marker.bindTooltip(String(pointNumber), {
        permanent: true,
        direction: 'center',
        className: 'point-label'
      });
      
      // Click on marker to remove it
      marker.on('click', function(e) {
        L.DomEvent.stopPropagation(e);
        removeRoutePoint(pointNumber - 1);
      });
      
      routeMarkers.push(marker);
      
      updateRoutePolyline();
      updateRouteDistance();
      updateRouteUI();
    }
    
    function updateRouteUI() {
      var count = routePoints.length;
      document.getElementById('routePointsCount').textContent = count + ' point' + (count > 1 ? 's' : '');
      
      // Update hint
      var hint = document.getElementById('routeHint');
      if (count === 0) {
        hint.textContent = 'üëÜ Tracez votre boucle sur l\'eau';
      } else if (count === 1) {
        hint.textContent = 'üëÜ Continuez le trac√©...';
      } else {
        hint.textContent = '‚úÖ Boucle de ' + (document.getElementById('routeDistanceLive').textContent) + ' km';
      }
    }
    
    function removeRoutePoint(index) {
      routePoints.splice(index, 1);
      
      // Remove all markers and recreate
      routeMarkers.forEach(function(m) { routeDrawMap.removeLayer(m); });
      routeMarkers = [];
      
      // Recreate markers with correct numbers
      routePoints.forEach(function(latlng, i) {
        var marker = L.circleMarker(latlng, {
          radius: 10,
          fillColor: i === 0 ? '#16a34a' : '#0369a1',
          color: 'white',
          weight: 3,
          fillOpacity: 1
        }).addTo(routeDrawMap);
        
        marker.bindTooltip(String(i + 1), {
          permanent: true,
          direction: 'center',
          className: 'point-label'
        });
        
        marker.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          removeRoutePoint(i);
        });
        
        routeMarkers.push(marker);
      });
      
      updateRoutePolyline();
      updateRouteDistance();
      updateRouteUI();
    }
    
    function updateRoutePolyline() {
      if (routePolyline) {
        routeDrawMap.removeLayer(routePolyline);
      }
      
      if (routePoints.length >= 2) {
        // Always close the loop
        var points = routePoints.slice();
        points.push(points[0]);
        
        routePolyline = L.polyline(points, {
          color: '#0369a1',
          weight: 4,
          opacity: 0.8
        }).addTo(routeDrawMap);
      }
    }
    
    function updateRouteDistance() {
      var distance = 0;
      for (var i = 1; i < routePoints.length; i++) {
        distance += routePoints[i-1].distanceTo(routePoints[i]);
      }
      // Add distance back to start (always a loop)
      if (routePoints.length >= 2) {
        distance += routePoints[routePoints.length - 1].distanceTo(routePoints[0]);
      }
      var km = (distance / 1000).toFixed(2);
      document.getElementById('routeDistanceLive').textContent = km;
    }
    
    function undoRoutePoint() {
      if (routePoints.length === 0) return;
      
      routePoints.pop();
      var marker = routeMarkers.pop();
      if (marker) routeDrawMap.removeLayer(marker);
      
      updateRoutePolyline();
      updateRouteDistance();
      updateRouteUI();
    }
    
    function clearRoutePoints() {
      routePoints = [];
      routeMarkers.forEach(function(m) { routeDrawMap.removeLayer(m); });
      routeMarkers = [];
      if (routePolyline) {
        routeDrawMap.removeLayer(routePolyline);
        routePolyline = null;
      }
      document.getElementById('routeDistanceLive').textContent = '0.00';
      updateRouteUI();
    }
    
    // ============== ROUTE DETAIL ==============
    var routeDetailMap = null;
    
    // Fake routes data - ALL routes are loops on water
    var fakeRoutes = {
      'triangle': [
        [43.2580, 5.3740],  // Start - in water off Prado beach
        [43.2565, 5.3780],  // East buoy
        [43.2550, 5.3740],  // South buoy
        [43.2580, 5.3740]   // Back to start (loop closed)
      ],
      'prado-david': [
        [43.2580, 5.3740],  // Start - Prado beach water
        [43.2560, 5.3700],  // Southwest
        [43.2540, 5.3660],  // Further southwest
        [43.2520, 5.3640],  // Near David statue
        [43.2540, 5.3680],  // Return east
        [43.2560, 5.3720],  // Return northeast
        [43.2580, 5.3740]   // Back to start (loop closed)
      ]
    };
    
    function openRoute(id, name, distance, level, swims, desc) {
      document.getElementById('routeName').textContent = name;
      document.getElementById('routeLocation').textContent = currentSpotName || 'Marseille';
      document.getElementById('routeDistanceBadge').textContent = distance + ' km';
      document.getElementById('routeSwimsBadge').textContent = swims + ' nages';
      document.getElementById('routeLevel').textContent = level;
      document.getElementById('routeDesc').textContent = desc;
      
      // Calculate duration - assume 3 km/h average speed
      var distanceKm = parseFloat(distance);
      var durationMin = Math.round(distanceKm / 3 * 60);
      var durationStr;
      if (durationMin >= 60) {
        var hours = Math.floor(durationMin / 60);
        var mins = durationMin % 60;
        durationStr = '~' + hours + 'h' + (mins > 0 ? mins : '');
      } else {
        durationStr = '~' + durationMin + ' min';
      }
      document.getElementById('routeDuration').textContent = durationStr;
      
      showScreen('route');
      
      // Initialize map after screen is shown
      setTimeout(function() {
        initRouteDetailMap(id, distanceKm);
      }, 100);
    }
    
    function initRouteDetailMap(routeId, distance) {
      var container = document.getElementById('routeDetailMap');
      if (!container) return;
      
      // Destroy existing map
      if (routeDetailMap) {
        routeDetailMap.remove();
        routeDetailMap = null;
      }
      
      // Get spot location
      var center = [43.2580, 5.3740];
      if (currentSpotId) {
        var spot = spots.find(function(s) { return s.id === currentSpotId; });
        if (spot) center = [spot.lat - 0.003, spot.lng]; // Offset south into water
      }
      
      routeDetailMap = L.map('routeDetailMap', {
        center: center,
        zoom: 15,
        zoomControl: false,
        dragging: true,
        scrollWheelZoom: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
      }).addTo(routeDetailMap);
      
      // Get route points or generate fake ones
      var routeCoords = fakeRoutes[routeId];
      if (!routeCoords) {
        // Generate a loop in the water around the center
        routeCoords = generateWaterLoop(center, distance);
      }
      
      // Draw the route (already closed loop)
      var polyline = L.polyline(routeCoords, {
        color: '#0369a1',
        weight: 4,
        opacity: 0.9
      }).addTo(routeDetailMap);
      
      // Add start/finish marker (green)
      L.circleMarker(routeCoords[0], {
        radius: 12,
        fillColor: '#16a34a',
        color: 'white',
        weight: 3,
        fillOpacity: 1
      }).addTo(routeDetailMap).bindTooltip('D√©part / Arriv√©e', { permanent: false });
      
      // Add waypoint markers (excluding start and end since they're the same)
      for (var i = 1; i < routeCoords.length - 1; i++) {
        L.circleMarker(routeCoords[i], {
          radius: 7,
          fillColor: '#0369a1',
          color: 'white',
          weight: 2,
          fillOpacity: 1
        }).addTo(routeDetailMap).bindTooltip('Bou√©e ' + i, { permanent: false });
      }
      
      // Fit bounds to route
      routeDetailMap.fitBounds(polyline.getBounds(), { padding: [30, 30] });
    }
    
    function generateWaterLoop(center, distanceKm) {
      // Generate a triangular/rectangular loop in water
      // Offset south (into water for most coastal spots)
      var radius = distanceKm / 4 * 0.008; // Rough conversion to degrees
      var waterOffset = -0.002; // Go south into water
      
      var points = [
        [center[0] + waterOffset, center[1]],                    // Start
        [center[0] + waterOffset - radius, center[1] + radius],  // SE
        [center[0] + waterOffset - radius * 1.5, center[1]],     // S
        [center[0] + waterOffset - radius, center[1] - radius],  // SW
        [center[0] + waterOffset, center[1]]                     // Back to start
      ];
      return points;
    }
    
    function backToSpot() {
      if (currentSpotId) {
        openSpot(currentSpotId);
      } else {
        showScreen('explore');
      }
    }
    
    // ============== SLIDER ==============
    document.getElementById('timeSlider').oninput = function() {
      var newTime = parseInt(this.value);
      document.getElementById('timeLabel').textContent = getTimeLabel(newTime);
      document.querySelectorAll('.slider-label').forEach(function(l, i) {
        l.classList.toggle('active', i === newTime);
      });
      updateMarkers(newTime);
      currentTime = newTime;
    };
    
    // ============== CREATE SCREEN ==============
    var createMap = null;
    var createMarker = null;
    var createLocation = null;
    var createMode = null; // 'spot', 'info', 'route'
    var createRoutePoints = [];
    var createRouteMarkers = [];
    var createRoutePolyline = null;
    var selectedSpotId = null;
    var createSpotMarkers = [];
    
    function initCreateMap() {
      if (createMap) {
        // Just refresh markers
        addSpotsToCreateMap();
        return;
      }
      
      var container = document.getElementById('createMap');
      if (!container) return;
      
      createMap = L.map('createMap', {
        center: [43.26, 5.37],
        zoom: 11,
        zoomControl: false
      });
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
      }).addTo(createMap);
      
      createMap.on('click', onCreateMapClick);
      
      // Add existing spots to the map
      addSpotsToCreateMap();
    }
    
    function addSpotsToCreateMap() {
      // Clear existing spot markers
      createSpotMarkers.forEach(function(m) { createMap.removeLayer(m); });
      createSpotMarkers = [];
      
      // Add markers for all spots
      spots.forEach(function(spot) {
        var marker = L.marker([spot.lat, spot.lng], {
          icon: L.divIcon({
            className: '',
            html: '<div style="width:36px;height:36px;background:white;border:3px solid #0369a1;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;font-size:16px;">üèä</div>',
            iconSize: [36, 36],
            iconAnchor: [18, 18]
          })
        }).addTo(createMap);
        
        marker.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          selectSpotForCreate(spot);
        });
        
        marker.bindTooltip(spot.name, { direction: 'top', offset: [0, -10] });
        
        createSpotMarkers.push(marker);
      });
    }
    
    function selectSpotForCreate(spot) {
      selectedSpotId = spot.id;
      
      // Clear any new spot marker
      if (createMarker) {
        createMap.removeLayer(createMarker);
        createMarker = null;
      }
      createLocation = null;
      
      // Update UI
      document.getElementById('createHint').style.display = 'none';
      document.getElementById('createCoords').style.display = 'none';
      document.getElementById('createActionsHint').style.display = 'none';
      document.getElementById('createSelectedSpot').style.display = 'flex';
      document.getElementById('selectedSpotName').textContent = spot.name;
      
      // Enable Info, Danger, Route buttons (not Spot)
      document.getElementById('btnCreateSpot').classList.add('disabled');
      document.getElementById('btnCreateInfo').classList.remove('disabled');
      document.getElementById('btnCreateDanger').classList.remove('disabled');
      document.getElementById('btnCreateRoute').classList.remove('disabled');
      
      // Center map on selected spot
      createMap.setView([spot.lat, spot.lng], 14);
    }
    
    function clearSelectedSpot() {
      selectedSpotId = null;
      
      // Reset UI
      document.getElementById('createHint').style.display = 'block';
      document.getElementById('createHint').textContent = 'üëÜ S√©lectionnez un spot ou cliquez pour en cr√©er un';
      document.getElementById('createCoords').style.display = 'none';
      document.getElementById('createActionsHint').textContent = 'üìç Cliquez sur un spot existant ou cr√©ez-en un nouveau';
      document.getElementById('createActionsHint').style.display = 'block';
      document.getElementById('createSelectedSpot').style.display = 'none';
      
      // All buttons disabled
      document.getElementById('btnCreateSpot').classList.add('disabled');
      document.getElementById('btnCreateInfo').classList.add('disabled');
      document.getElementById('btnCreateDanger').classList.add('disabled');
      document.getElementById('btnCreateRoute').classList.add('disabled');
    }
    
    function onCreateMapClick(e) {
      if (createMode === 'route') {
        // Add route point
        addCreateRoutePoint(e.latlng);
      } else {
        // Place marker for spot/info
        placeCreateMarker(e.latlng);
      }
    }
    
    function placeCreateMarker(latlng) {
      // Clear selected spot
      selectedSpotId = null;
      document.getElementById('createSelectedSpot').style.display = 'none';
      
      if (createMarker) {
        createMap.removeLayer(createMarker);
      }
      
      createMarker = L.marker(latlng, {
        icon: L.divIcon({
          className: '',
          html: '<div style="width:36px;height:36px;background:#16a34a;border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-size:18px;font-weight:bold;">+</div>',
          iconSize: [36, 36],
          iconAnchor: [18, 18]
        })
      }).addTo(createMap);
      
      createLocation = latlng;
      
      // Open spot creation form directly
      createMode = 'spot';
      document.getElementById('createHint').style.display = 'none';
      document.getElementById('createCoords').style.display = 'none';
      document.getElementById('createActionsHint').style.display = 'none';
      document.getElementById('createFormSpot').style.display = 'block';
      document.getElementById('createActions').style.display = 'none';
      
      // Show coordinates in form
      document.getElementById('newSpotCoords').textContent = latlng.lat.toFixed(4) + ', ' + latlng.lng.toFixed(4);
      
      // Update karma status
      updateKarmaRequirementUI();
    }
    
    function updateKarmaRequirementUI() {
      var container = document.getElementById('karmaRequirement');
      var status = document.getElementById('karmaReqStatus');
      
      if (userKarma >= KARMA_REQUIRED_SPOT) {
        container.classList.remove('insufficient');
        status.textContent = '‚úì Vous avez ' + userKarma + ' karma';
      } else {
        container.classList.add('insufficient');
        status.textContent = '‚úó Vous avez ' + userKarma + ' karma';
      }
    }
    
    function clearCreateMarker() {
      if (createMarker) {
        createMap.removeLayer(createMarker);
        createMarker = null;
      }
      createLocation = null;
      selectedSpotId = null;
      
      document.getElementById('createHint').style.display = 'block';
      document.getElementById('createHint').textContent = 'üëÜ S√©lectionnez un spot ou cliquez pour en cr√©er un';
      document.getElementById('createCoords').style.display = 'none';
      document.getElementById('createSelectedSpot').style.display = 'none';
      document.getElementById('createActionsHint').textContent = 'üìç Cliquez sur un spot existant ou cr√©ez-en un nouveau';
      document.getElementById('createActionsHint').style.display = 'block';
      
      // All buttons disabled
      document.getElementById('btnCreateSpot').classList.add('disabled');
      document.getElementById('btnCreateInfo').classList.add('disabled');
      document.getElementById('btnCreateDanger').classList.add('disabled');
      document.getElementById('btnCreateRoute').classList.add('disabled');
    }
    
    function startCreateSpot() {
      if (document.getElementById('btnCreateSpot').classList.contains('disabled')) {
        showToast('Cliquez d\'abord sur la carte');
        return;
      }
      if (!createLocation) return;
      createMode = 'spot';
      document.getElementById('createFormSpot').style.display = 'block';
      document.getElementById('createActions').style.display = 'none';
    }
    
    function startCreateInfo(type) {
      var btnId = type === 'danger' ? 'btnCreateDanger' : 'btnCreateInfo';
      if (document.getElementById(btnId).classList.contains('disabled')) {
        showToast('S√©lectionnez d\'abord un spot');
        return;
      }
      if (!selectedSpotId) return;
      createMode = 'info';
      document.getElementById('createFormInfo').style.display = 'block';
      document.getElementById('createActions').style.display = 'none';
      
      // Pre-select type
      var buttons = document.querySelectorAll('#createFormInfo .type-btn');
      if (type === 'danger') {
        buttons.forEach(function(btn, i) {
          btn.classList.toggle('active', i === 2);
        });
        document.getElementById('createFormInfoTitle').textContent = 'üö® Signaler un danger';
      } else {
        buttons.forEach(function(btn, i) {
          btn.classList.toggle('active', i === 0);
        });
        document.getElementById('createFormInfoTitle').textContent = 'üí° Info locale';
      }
      
      // Show which spot we're adding to
      var spot = spots.find(function(s) { return s.id === selectedSpotId; });
      if (spot) {
        document.getElementById('createFormInfoTitle').textContent += ' ‚Äî ' + spot.name;
      }
    }
    
    function startCreateRoute() {
      if (document.getElementById('btnCreateRoute').classList.contains('disabled')) {
        showToast('S√©lectionnez d\'abord un spot');
        return;
      }
      if (!selectedSpotId) return;
      createMode = 'route';
      createRouteLoopClosed = false;
      document.getElementById('createFormRoute').style.display = 'block';
      document.getElementById('createActions').style.display = 'none';
      
      // Center on spot for route drawing
      var spot = spots.find(function(s) { return s.id === selectedSpotId; });
      if (spot) {
        createMap.setView([spot.lat - 0.005, spot.lng], 15);
      }
      
      document.getElementById('routeDrawHint').textContent = 'üëÜ Cliquez sur la carte pour tracer';
      document.getElementById('closeCreateLoopBtn').style.display = 'none';
    }
    
    function hideCreateForm() {
      createMode = null;
      document.getElementById('createFormSpot').style.display = 'none';
      document.getElementById('createFormInfo').style.display = 'none';
      document.getElementById('createFormRoute').style.display = 'none';
      document.getElementById('createActions').style.display = 'block';
      
      // Clear route if any
      clearCreateRoutePoints();
      
      // Restore UI based on current state
      if (selectedSpotId) {
        var spot = spots.find(function(s) { return s.id === selectedSpotId; });
        document.getElementById('createHint').style.display = 'none';
        document.getElementById('createCoords').style.display = 'none';
        document.getElementById('createSelectedSpot').style.display = 'flex';
        document.getElementById('selectedSpotName').textContent = spot ? spot.name : '';
        document.getElementById('createActionsHint').style.display = 'none';
      } else if (createLocation) {
        document.getElementById('createHint').style.display = 'none';
        document.getElementById('createCoords').style.display = 'flex';
        document.getElementById('createSelectedSpot').style.display = 'none';
        document.getElementById('createActionsHint').style.display = 'block';
      } else {
        document.getElementById('createHint').style.display = 'block';
        document.getElementById('createHint').textContent = 'üëÜ S√©lectionnez un spot ou cliquez pour en cr√©er un';
        document.getElementById('createCoords').style.display = 'none';
        document.getElementById('createSelectedSpot').style.display = 'none';
        document.getElementById('createActionsHint').style.display = 'block';
      }
    }
    
    function selectCreateInfoType(btn, type) {
      document.querySelectorAll('#createFormInfo .type-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
    }
    
    function cancelCreateSpot() {
      // Close form and clear marker
      createMode = null;
      document.getElementById('createFormSpot').style.display = 'none';
      document.getElementById('createActions').style.display = 'block';
      clearCreateMarker();
    }
    
    function repositionSpot() {
      // Close form but keep listening for new click
      createMode = null;
      document.getElementById('createFormSpot').style.display = 'none';
      document.getElementById('createActions').style.display = 'block';
      
      // Clear current marker
      if (createMarker) {
        createMap.removeLayer(createMarker);
        createMarker = null;
      }
      createLocation = null;
      
      // Show hint to reposition
      document.getElementById('createHint').style.display = 'block';
      document.getElementById('createHint').textContent = 'üëÜ Cliquez pour placer le nouveau spot';
      document.getElementById('createActionsHint').style.display = 'none';
      
      showToast('Cliquez pour repositionner');
    }
    
    function submitNewSpot() {
      // Check karma requirement
      if (userKarma < KARMA_REQUIRED_SPOT) {
        showToast('Karma insuffisant (min. ' + KARMA_REQUIRED_SPOT + ' ‚≠ê)');
        return;
      }
      
      var name = document.getElementById('newSpotName').value;
      if (!name) {
        showToast('Donnez un nom au spot');
        return;
      }
      
      var desc = document.getElementById('newSpotDesc').value || 'Nouveau spot ajout√© par la communaut√©.';
      var type = document.getElementById('newSpotType').value;
      var access = document.getElementById('newSpotAccess').value;
      
      // Create new spot object
      var newSpot = {
        id: 'spot-' + nextSpotId++,
        name: name,
        region: 'Communaut√©',
        lat: createLocation.lat,
        lng: createLocation.lng,
        type: type,
        access: access,
        description: desc,
        conditions: [
          { temp: 17, wind: 12, waves: 0.4, status: 'favorable' },
          { temp: 17, wind: 14, waves: 0.5, status: 'favorable' },
          { temp: 17, wind: 16, waves: 0.6, status: 'technique' },
          { temp: 16, wind: 18, waves: 0.7, status: 'technique' },
          { temp: 16, wind: 20, waves: 0.8, status: 'exigeant' },
          { temp: 16, wind: 15, waves: 0.5, status: 'technique' }
        ]
      };
      
      // Add to spots array
      spots.push(newSpot);
      
      // Add marker to main map
      addSpotMarker(newSpot);
      
      // Add marker to create map
      addSpotsToCreateMap();
      
      // Update karma
      userKarma += 20;
      updateKarmaDisplay();
      
      // Clear form
      document.getElementById('newSpotName').value = '';
      document.getElementById('newSpotDesc').value = '';
      
      // Clear create marker
      if (createMarker) {
        createMap.removeLayer(createMarker);
        createMarker = null;
      }
      createLocation = null;
      createMode = null;
      
      // Close form
      document.getElementById('createFormSpot').style.display = 'none';
      document.getElementById('createActions').style.display = 'block';
      
      // Show success
      showToast('Spot cr√©√© ! +20 karma ‚≠ê');
      
      // Open the new spot's detail page
      setTimeout(function() {
        showScreen('explore');
        setTimeout(function() {
          openSpot(newSpot.id);
        }, 300);
      }, 500);
    }
    
    function addSpotMarker(spot) {
      var cond = spot.conditions[currentTime];
      var statusColors = {
        favorable: '#16a34a',
        technique: '#f59e0b', 
        exigeant: '#ef4444'
      };
      
      var marker = L.marker([spot.lat, spot.lng], {
        icon: L.divIcon({
          className: '',
          html: '<div style="width:28px;height:28px;background:' + statusColors[cond.status] + ';border:3px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.3);cursor:pointer;"></div>',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        })
      }).addTo(map);
      
      marker.on('click', function() { openSpot(spot.id); });
      marker.spotId = spot.id;
      markers.push(marker);
    }
    
    function updateKarmaDisplay() {
      // Update profile karma display
      var karmaDisplays = document.querySelectorAll('[data-karma-display]');
      karmaDisplays.forEach(function(el) {
        el.textContent = userKarma;
      });
    }
    
    function submitNewInfo() {
      var title = document.getElementById('newInfoTitle').value;
      if (!title) {
        showToast('Donnez un titre √† l\'info');
        return;
      }
      hideCreateForm();
      clearCreateMarker();
      showToast('Info publi√©e ! +10 karma ‚≠ê');
      document.getElementById('newInfoTitle').value = '';
      document.getElementById('newInfoDesc').value = '';
    }
    
    // Route drawing in create mode - with manual loop closing
    var createRouteLoopClosed = false;
    
    function addCreateRoutePoint(latlng) {
      if (createRouteLoopClosed) return; // Can't add points after loop is closed
      
      createRoutePoints.push(latlng);
      
      var marker = L.circleMarker(latlng, {
        radius: 10,
        fillColor: createRoutePoints.length === 1 ? '#16a34a' : '#0369a1',
        color: 'white',
        weight: 3,
        fillOpacity: 1
      }).addTo(createMap);
      
      marker.bindTooltip(String(createRoutePoints.length), {
        permanent: true,
        direction: 'center',
        className: 'point-label'
      });
      
      createRouteMarkers.push(marker);
      
      updateCreateRoutePolyline();
      updateCreateRouteUI();
    }
    
    function updateCreateRoutePolyline() {
      if (createRoutePolyline) {
        createMap.removeLayer(createRoutePolyline);
      }
      
      if (createRoutePoints.length >= 2) {
        var points = createRoutePoints.slice();
        // Only close loop if user clicked "Boucler"
        if (createRouteLoopClosed) {
          points.push(points[0]);
        }
        
        createRoutePolyline = L.polyline(points, {
          color: '#0369a1',
          weight: 4,
          opacity: 0.8
        }).addTo(createMap);
      }
    }
    
    function updateCreateRouteUI() {
      // Calculate total distance
      var distance = 0;
      for (var i = 1; i < createRoutePoints.length; i++) {
        distance += createRoutePoints[i-1].distanceTo(createRoutePoints[i]);
      }
      // Add distance back to start only if loop is closed
      if (createRouteLoopClosed && createRoutePoints.length >= 2) {
        distance += createRoutePoints[createRoutePoints.length - 1].distanceTo(createRoutePoints[0]);
      }
      var km = (distance / 1000).toFixed(2);
      document.getElementById('routeDrawDistance').textContent = km + ' km';
      
      var hint = document.getElementById('routeDrawHint');
      var closeBtn = document.getElementById('closeCreateLoopBtn');
      
      if (createRoutePoints.length === 0) {
        hint.textContent = 'üëÜ Cliquez sur la carte pour tracer';
        closeBtn.style.display = 'none';
      } else if (createRoutePoints.length === 1) {
        hint.textContent = 'üëÜ Continuez le trac√©...';
        closeBtn.style.display = 'none';
      } else if (createRouteLoopClosed) {
        hint.textContent = '‚úÖ Boucle ferm√©e ¬∑ ' + km + ' km';
        closeBtn.style.display = 'none';
      } else {
        hint.textContent = createRoutePoints.length + ' points ¬∑ ' + km + ' km';
        closeBtn.style.display = 'block';
      }
    }
    
    function closeCreateRouteLoop() {
      if (createRoutePoints.length < 2) return;
      createRouteLoopClosed = true;
      updateCreateRoutePolyline();
      updateCreateRouteUI();
      showToast('Boucle ferm√©e !');
    }
    
    function undoCreateRoutePoint() {
      if (createRouteLoopClosed) {
        // Reopen loop first
        createRouteLoopClosed = false;
        updateCreateRoutePolyline();
        updateCreateRouteUI();
        return;
      }
      
      if (createRoutePoints.length === 0) return;
      
      createRoutePoints.pop();
      var marker = createRouteMarkers.pop();
      if (marker) createMap.removeLayer(marker);
      
      updateCreateRoutePolyline();
      updateCreateRouteUI();
    }
    
    function clearCreateRoutePoints() {
      createRoutePoints = [];
      createRouteMarkers.forEach(function(m) { createMap.removeLayer(m); });
      createRouteMarkers = [];
      if (createRoutePolyline) {
        createMap.removeLayer(createRoutePolyline);
        createRoutePolyline = null;
      }
      createRouteLoopClosed = false;
      if (document.getElementById('routeDrawDistance')) {
        document.getElementById('routeDrawDistance').textContent = '0.00 km';
      }
      if (document.getElementById('routeDrawHint')) {
        document.getElementById('routeDrawHint').textContent = 'üëÜ Cliquez sur la carte pour tracer';
      }
      var closeBtn = document.getElementById('closeCreateLoopBtn');
      if (closeBtn) closeBtn.style.display = 'none';
    }
    
    function submitNewRoute() {
      var name = document.getElementById('newRouteName').value;
      if (!name) {
        showToast('Donnez un nom au parcours');
        return;
      }
      if (createRoutePoints.length < 2) {
        showToast('Tracez au moins 2 points');
        return;
      }
      if (!createRouteLoopClosed) {
        showToast('Cliquez "Boucler" pour fermer le parcours');
        return;
      }
      hideCreateForm();
      showToast('Parcours cr√©√© ! +25 karma ‚≠ê');
      document.getElementById('newRouteName').value = '';
    }
    
    // ============== INIT ==============
    window.onload = function() {
      document.getElementById('timeLabel').textContent = getTimeLabel(0);
      initMap();
    };
  </script>
</body>
</html>
